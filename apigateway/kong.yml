_format_version: '2.1'
_transform: true

services:

#
# The main stocks API route serves other types of API clients
#
- name: stocks-api
  url: http://stocks-api:3000/
  routes:
  - name: stocks-api-route
    hosts:
    - api.demo.example
    paths:
    - /stocks
  plugins:
  - name: phantom-token
    config:
      introspection_endpoint: http://idsvr:8443/oauth/v2/oauth-introspect
      client_id: api-gateway-client
      client_secret: Password1
      token_cache_seconds: 900

#
# All MCP client API requests use this API gateway entry point
# The MCP server connection is secured by opaque access tokens
#
- name: mcp-server
  url: http://mcp-server:3000/
  routes:
  - name: mcp-server-route
    hosts:
    - mcp.demo.example
    paths:
    - /
  plugins:
  - name: cors
    config:
      origins:
      - 'http://localhost:6274'
  - name: phantom-token
    config:
      introspection_endpoint: http://idsvr:8443/oauth/v2/oauth-introspect
      client_id: api-gateway-client
      client_secret: Password1
      token_cache_seconds: 900

#
# The MCP server exposes OAuth protected resource metadata that points MCP clients to the authorization server
# This endpoint is not secured so we use a different route for it
#
- name: mcp-server-resource-metadata
  url: http://mcp-server:3000/.well-known/oauth-protected-resource
  routes:
  - name: mcp-server-resource-metadata-route
    hosts:
    - mcp.demo.example
    paths:
    - /.well-known/oauth-protected-resource
  plugins:
  - name: cors
    config:
      origins:
      - 'http://localhost:6274'

#
# MCP authorization requires a root level OAuth authorization server metadata endpoint
# - https://github.com/modelcontextprotocol/typescript-sdk/issues/545
#
- name: authorization-server-metadata-reroute
  url: http://idsvr:8443/.well-known/oauth-authorization-server/oauth/v2/oauth-anonymous
  routes:
  - name: authorization-server-metadata-reroute
    hosts:
    - login.demo.example
    paths:
    - /.well-known/oauth-authorization-server
  plugins:
  - name: cors
    config:
      origins:
      - 'http://localhost:6274'

#
# The settings token_endpoint_auth_method=none and client_uri are incompatible with the Curity Identity Server
# Therefore, use Kong's request transformer plugin to update incoming requests
#
- name: authorization-server-registration
  url: http://idsvr:8443/oauth/v2/oauth-registration
  routes:
  - name: authorization-server-registration
    hosts:
    - login.demo.example
    paths:
    - /oauth/v2/oauth-registration
  plugins:
  - name: cors
    config:
      origins:
      - 'http://localhost:6274'
  - name: request-transformer
    enabled: yes
    config:
      remove:
        body:
        - token_endpoint_auth_method:none
        - client_uri
      add:
        body:
        - token_endpoint_auth_method:client_secret_basic

#
# All other authorization server endpoints
#
- name: authorization-server
  url: http://idsvr:8443
  routes:
  - name: oauth-route
    hosts:
    - login.demo.example
    paths:
    - /
  plugins:
  - name: cors
    config:
      origins:
      - 'http://localhost:6274'

#
# The admin UI for the Curity Identity Server
#
- name: admin-ui
  url: http://idsvr:6749
  routes:
  - name: admin-ui-route
    hosts:
    - admin.demo.example
    paths:
    - /

#
# The email inbox for testing
#
- name: email-inbox
  url: http://smtpserver:1080
  routes:
  - name: email-inbox-route
    hosts:
    - mail.demo.example
    paths:
    - /
