_format_version: '2.1'
_transform: true

services:

#
# The MCP server requires an opaque access token that passes introspection
#
- name: utility-mcp-server
  url: http://utility-mcp-server:3000
  routes:
  - name: utility-mcp-server-route
    hosts:
    - mcp.demo.example
    paths:
    - /stocks
  plugins:
    - name: phantom-token
      config:
        introspection_endpoint: http://idsvr:8443/oauth/v2/oauth-introspect
        client_id: api-gateway-client
        client_secret: Password1
        token_cache_seconds: 900
        resource_metadata_url: http://api.demo.example/stocks

#
# Each API exposes its own resource server metadata at an unsecured endpoint
#
- name: stocks-api-resource-metadata
  url: http://stocks-api:3000/.well-known/oauth-protected-resource
  routes:
  - name: utility-mcp-server-well-known-resource-route
    hosts:
    - api.demo.example
    paths:
    # I want to use this path
    - /stocks/.well-known/oauth-protected-resource
    # But the TypeScript SDK requires a fixed path of /.well-known/oauth-protected-resource, which only works for one API
    - /.well-known/oauth-protected-resource

#
# The stocks API can serve AI agents and also other types of clients
#
- name: stocks-api
  url: http://stocks-api:3000/
  routes:
  - name: stocks-api-route
    hosts:
    - api.demo.example
    paths:
    - /stocks
  plugins:
    - name: phantom-token
      config:
        introspection_endpoint: http://idsvr:8443/oauth/v2/oauth-introspect
        client_id: api-gateway-client
        client_secret: Password1
        token_cache_seconds: 900
        resource_metadata_url: http://api.demo.example/stocks

#
# The admin UI for the Curity Identity Server
#
- name: admin-ui
  url: http://idsvr:6749
  routes:
  - name: admin-ui-route
    hosts:
    - admin.demo.example
    paths:
    - /

#
# A path rewrite to expose authorization server metadata at the expected location
#
- name: authorization-server-metadata
  url: http://idsvr:8443/.well-known/oauth-authorization-server/oauth/v2/oauth-anonymous
  routes:
  - name: oauth-metadata-route
    hosts:
    - login.demo.example
    paths:
    - /.well-known/oauth-authorization-server

#
# The main authorization server endpoints
#
- name: authorization-server
  url: http://idsvr:8443
  routes:
  - name: oauth-route
    hosts:
    - login.demo.example
    paths:
    - /

#
# The email inbox for testing
#
- name: email-inbox
  url: http://smtpserver:1080
  routes:
  - name: email-inbox-route
    hosts:
    - mail.demo.example
    paths:
    - /
